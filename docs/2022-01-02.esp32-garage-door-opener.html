<!DOCTYPE html>

<head>
    <title>JOE MAKES</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;700&amp;display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="favicon.jpg" />
</head>

<div>
    <h1 class="title">JOE MAKES</h1>
    <p>
        <!--<a href='index.html'>HOME</a> / <a href='listen.html'>LISTEN</a> / <a href="archive.html">ARCHIVE</a> / <a href="shop.html">SHOP</a>-->
        <a href='https://samela.io/'>HOME</a> / <a href="archive.html">PROJECTS</a>
    </p>
    <p class="horizontal-rule">
        &#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;
    </p>
    <div><!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title></title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<p><br><a href="https://github.com/JosephSamela/esp32-garage-door-opener">See project on github!</a></p>
<h1 id="esp32-garage-door-opener">esp32-garage-door-opener</h1>
<p>esp32 IoT device to open/close your garage door with Apple HomeKit</p>
<p><img src="https://raw.githubusercontent.com/JosephSamela/esp32-garage-door-opener/main/photos/photo-final-build.JPG" /></p>
<h2 id="software">Software</h2>
<p>This device can be controlled completely independent of any smart-home infastructure. It’s simply an IoT “thing” you send HTTP GET requests to open/close your garage door.</p>
<p>That said, I personally am integrating this with Apple HomeKit. In order to do this you’ll need a local instance of <a href="https://homebridge.io/">Homebridge</a>. You’ll also need to install the <a href="https://github.com/phenotypic/homebridge-http-garage">homebridge-http-garage</a> plugin for homebridge.</p>
<p>Once connected to your network, set a DHCP reservation so the device retains it’s IP address. Then you can control it by sending HTTP requests to the routes below:</p>
<h3 id="routes">Routes</h3>
<p>The <code>/</code> endpoint is purely informational. It’s helpful when setting up the garage door the first time.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode abc"><code class="sourceCode abc"><a class="sourceLine" id="cb1-1" title="1">/</a></code></pre></div>
<p>The <code>/toggle</code> endpoint toggles the garage door. It’s equivelant to you pushing the garage door button.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode abc"><code class="sourceCode abc"><a class="sourceLine" id="cb2-1" title="1">/toggle</a></code></pre></div>
<p>The <code>status</code> endpoint will return json indicating the state of the garage door. <code>{"currentState":0}</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode abc"><code class="sourceCode abc"><a class="sourceLine" id="cb3-1" title="1">/status</a></code></pre></div>
<p>The <code>setState</code> route accepts a query param called <code>value</code>. You can set state to <code>0</code> (open) or <code>1</code> (closed).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode abc"><code class="sourceCode abc"><a class="sourceLine" id="cb4-1" title="1">/setState?value=INT_VALUE</a></code></pre></div>
<h3 id="homebridge-configuration">Homebridge Configuration</h3>
<p>I recommend following the default homebridge configuration suggested by the <a href="https://github.com/phenotypic/homebridge-http-garage">homebridge-http-garage</a> plugin readme. Here’s what I use:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb5-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="dt">&quot;accessory&quot;</span><span class="fu">:</span> <span class="st">&quot;GarageDoorOpener&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Garage Door&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="dt">&quot;apiroute&quot;</span><span class="fu">:</span> <span class="st">&quot;http://192.168.1.35&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="dt">&quot;openTime&quot;</span><span class="fu">:</span> <span class="dv">13</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="dt">&quot;closeTime&quot;</span><span class="fu">:</span> <span class="dv">13</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="dt">&quot;autoLock&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-8" title="8">    <span class="dt">&quot;autoLockDelay&quot;</span><span class="fu">:</span> <span class="dv">20</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-9" title="9">    <span class="dt">&quot;pollInterval&quot;</span><span class="fu">:</span> <span class="dv">120</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="dt">&quot;timeout&quot;</span><span class="fu">:</span> <span class="dv">2000</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="dt">&quot;http_method&quot;</span><span class="fu">:</span> <span class="st">&quot;GET&quot;</span></a>
<a class="sourceLine" id="cb5-12" title="12"><span class="fu">}</span></a></code></pre></div>
<h2 id="hardware">Hardware</h2>
<p>The hardware is an ESP32 microcontroller with a relay module. The rear of the garage door unit has three screw terminals connected to the wall switch.</p>
<p>The relay is connected between the two screw terminals connected to the garage door opener push-button. When the relay is closed the garage door unit recognizes this as a “button press” and opens/closes the door as if you pushed the button on the wall.</p>
<p>From the ESP32, I’m driving the relay board with <code>3.3V</code> and <code>GND</code> and using <code>D15</code> as the control pin set HIGH or LOW to control the relay.</p>
<h2 id="installation">Installation</h2>
<p>Wire microcontroller to relay, and relay to garagedoor as shown.</p>
<p><img src="https://raw.githubusercontent.com/JosephSamela/esp32-garage-door-opener/main/photos/screenshot1.jpg" /></p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">ESP32</th>
<th style="text-align: center;">Relay</th>
<th style="text-align: center;">Garage Door</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">3.3V</td>
<td style="text-align: center;">VCC</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">GND</td>
<td style="text-align: center;">GND</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">D15</td>
<td style="text-align: center;">IN</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: center;">NC</td>
<td style="text-align: center;">Switch 1</td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;">C</td>
<td style="text-align: center;">Switch 2</td>
</tr>
</tbody>
</table>
<h2 id="troubleshooting">Troubleshooting</h2>
<p><em>Does your sensor work initially, then become unresponsive?</em></p>
<p>I had this issue after setting up my Homekit Hub (Apple TV). The sensor would become unresponsibe and require a restart ever couple hours. I found this was caused by the ESP32 WebServer library’s default socket timeout.</p>
<p>The HomeKit hub constantly polls the device to check it’s status. Every time it does this, the HomeKit Hub (client) opens a socket connection to your device to request data. The WebServer will maintain that connection until the client closes the connection OR the connection times out.</p>
<p>For some reason the sockets are not being closed and hang around until they timeout. Since the default timeout is long (2 seconds) all of these connections are being created faster then they’re timing out and piling up until the server becomes unresponsive.</p>
<p>Here’s how I fixed it. Find the <code>WebServer.h</code> header file. Located here on my computer.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode abc"><code class="sourceCode abc"><a class="sourceLine" id="cb6-1" title="1"><span class="fl">C:\Users\&lt;username&gt;\AppData\Local\Arduino15\packages\esp32\hardware\esp32\2.0.2\libraries\WebServer\src\WebServer.h</span></a></code></pre></div>
<p>Look for the line defining the <code>HTTP_MAX_CLOSE_WAIT</code> variable and change the default from <code>2000</code> to <code>100</code>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb7-1" title="1"><span class="pp">#define HTTP_MAX_CLOSE_WAIT </span><span class="dv">100</span><span class="pp"> </span><span class="co">//ms to wait for the client to close the connection</span></a></code></pre></div>
<p>Recompile and flash your firmware.</p>
</body>
</html>
<footer>
    <div>
        <p class="horizontal-rule">
            &#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;&#x2592;</p>
        <p>
            <strong>JOE MAKES</strong> &#xa9; 2020 <a href='https://josephsamela.github.io/'>Joseph Samela</a></p>
    </div>
</footer>
Site generated 2022-06-01
